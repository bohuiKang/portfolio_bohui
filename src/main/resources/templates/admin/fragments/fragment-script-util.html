<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<script th:inline="javascript" th:fragment="util">

    /*<![CDATA[*/

    // 페이지 속성 '[[' ']]'로 감싸줘야 함(thymeleaf)
    const pageName = [[${pageName}]];
    const pageId = pageName.toString().toLowerCase();
    const editable = [[${editable}]];
    const deletable = [[${deletable}]];
    const hasDetails = [[${hasDetails}]];

    // 버튼 컴포넌트 정의 - 문자열로 html 태그를 만듦
    const detailsButton = "<button type=\"button\" class=\"btn btn-light\" onclick=\"getDetails(this)\">조회</button>";
    const editButton = "<button type=\"button\" class=\"btn btn-ligit\" data-bs-toggle=\"modal\" data-bs-target=\"#" + pageName + "Modal\" onclick=\"openEdit(this)\"><i class=\"bi bi-pencil\"></button>"
    const deleteButton = "<button type=\"button\" class=\"btn btn-ligit\" onclick=\"deleteRecord(this)\"><i class=\"bi bi-x-square\"></button>"

    // 데이터테이블 초기화
    var table = [[${table}]];
    var datatable = createDatatable(table.name, table.columns, table.records, editable, deletable, hasDetails);
    if (hasDetails) {
        var detailTable = [[${detailTable}]]
        detailDatatable = createDatatable(detailTable.name, detailTable.columns, detailTable.records, false, false, false);
    }

    // "key" : value 형태로 디테일을 미리 복사해서 변수에 추가한다
    var detailRows = null;
    if (hasDetails) {
        detailRows = {
            "detail": document.getElementsByClassName("detail")[0].cloneNode(true),
            "modalDetail": document.getElementsByClassName("modalDetail")[0].cloneNode(true)
        }
    }

    function createDatatable(tableName, tableColumns, tableRecords, editable, deletable, hasDetails) {

        var tableId = "#" + tableName; // '#' => css, javascript에서 id를 가리킨다.

        // 편집 가능할 경우 컬럼 및 버튼 추가 (true 일 때, 버튼 생성)
        if (editable) {
            tableColumns.push("edit")
            tableRecords.forEach(list => list.push(editButton))
        }

        // 삭제 가능할 경우 컬럼 및 버튼 추가
        if (deletable) {
            tableColumns.push("delete")
            tableRecords.forEach(list => list.push(deleteButton))
        }

        // 상세 데이터 포함일 경우 컬럼 및 버튼 추가
        if (hasDetails) {
            tableColumns.push("details")
            tableRecords.forEach(list => list.push(detailsButton))
        }

        return new simpleDatatables.DataTable(tableId, {
            data: {
                "headings": tableColumns,
                "data" : tableRecords
            }
        });
    }

    // Detail Form Element 추가
    function addDetail(className) { // 'detail', 'modalDetail'
        var elements = document.getElementsByClassName(className); // 배열로 요소 get
        var lastElement = elements[elements.length - 1];
        lastElement.insertAdjacentElement("afterend", detailRows[className].cloneNode(true));

        /* 로그 찍어서 확인
        console.log('document.getElementsByClassName(className)');
        console.log(document.getElementsByClassName(className));
        console.log('document.getElementsByClassName(className)[0]');
        console.log(document.getElementsByClassName(className)[0]);
        console.log('elements[elements.length - 1]');
        console.log(elements[elements.length - 1]);
        console.log('detailRows[className]');
        console.log(detailRows[className]); */
    }

    // 신규 데이터 저장
    function save() {

        // 요청 데이터 세팅
        var target = "." + pageName + "FormElement"; // ex => .IntroductionFormElement
        var body = createRequestBodyJson(target);
        if (hasDetails) {
            addDetailsToRequest(body, "detail");
        }
        var urlPath = getUrlPathFrom(pageName);
        var url = "/admin/api" + urlPath;
        httpRequest("POST", url, body, true);
    }

    // Form에서 JSON 생성
    function createRequestBodyJson(target) {
        var body = {}; // 빈 json 생성
        var formElements = getFormElements(target);
        formElements.forEach(element => body[element.name] = element.value);
        return body;
    }

    // Form Element 조회
    function getFormElements(target) {
        var selector = target + " input, " + target + " select";
        return document.querySelectorAll(selector);
    }

    // Request Body에 details 추가
    function addDetailsToRequest(body, className) {
        body["details"] = [];
        var details = document.querySelectorAll("." + className);

        for (let i = 0; i < details.length; i++) {
            var detail = {}
            var detailFormElements = details[i].querySelectorAll("input, select");
            detailFormElements.forEach(detailFormElement => {
                if (detailFormElement.value != null && detailFormElement.value.trim().length > 0) {
                    detail[detailFormElement.name] = detailFormElement.value;
                }
            });

            if (Object.keys(detail).length > 0) {
                body["details"].push(detail);
            }
        }
    }

    // 페이지명을 URL 포맷으로 변경
    function getUrlPathFrom(pageName) {
        const splits = pageName.replace(/([A-Z])/g, " $1").trim().split(" ")

        var refined = "";
        for (let i = 0; i < splits.length; i++) {
            refined += "/";
            refined += splits[i].charAt(0).toLowerCase() + splits[i].slice(1) + "s";
        } // ex -> /projects/skills

        return refined;
    }

    // HTTP 통신
    function httpRequest(method, url, body, reload) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, url, true);
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send(JSON.stringify(body));

        xhr.onload = () => {
            if (xhr.response != "") {
                alert(xhr.response);
            }
            if (reload) {
                location.reload();
            }
        }

        return xhr;
    }

    /*]]>*/

</script>

</body>
</html>